import sys
from PyQt5.QtWidgets import (
    QWidget, QApplication, QMainWindow, QDialog, QLabel, QLineEdit, QPushButton, QVBoxLayout, 
    QMessageBox, QFormLayout, QTableWidget, QTableWidgetItem, QHeaderView
)
from PyQt5.QtCore import Qt
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from produto import Produto, Base, Usuario

# Definir a conexão com o banco de dados SQLite
DATABASE_URL = "sqlite:///produtos.db"
engine = create_engine(DATABASE_URL, echo=True)
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)
session = Session()

class RegistroDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Registrar Novo Usuário")

        layout = QFormLayout()
        self.entry_username = QLineEdit()
        self.entry_password = QLineEdit()
        self.entry_password.setEchoMode(QLineEdit.Password)

        layout.addRow(QLabel("Username:"), self.entry_username)
        layout.addRow(QLabel("Password:"), self.entry_password)

        register_button = QPushButton("Registrar")
        register_button.clicked.connect(self.registrar_usuario)
        layout.addRow(register_button)

        self.setLayout(layout)

    def registrar_usuario(self):
        username = self.entry_username.text()
        password = self.entry_password.text()

        if session.query(Usuario).filter_by(username=username).first():
            QMessageBox.warning(self, "Erro", "Usuário já existe!")
        else:
            novo_usuario = Usuario(username=username, password=password)
            session.add(novo_usuario)
            session.commit()
            QMessageBox.information(self, "Sucesso", "Usuário registrado com sucesso!")
            self.close()

class LoginDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Login")

        layout = QFormLayout()
        self.entry_username = QLineEdit()
        self.entry_password = QLineEdit()
        self.entry_password.setEchoMode(QLineEdit.Password)

        layout.addRow(QLabel("Username:"), self.entry_username)
        layout.addRow(QLabel("Password:"), self.entry_password)

        login_button = QPushButton("Login")
        login_button.clicked.connect(self.verificar_login)
        layout.addRow(login_button)

        self.setLayout(layout)

    def verificar_login(self):
        username = self.entry_username.text()
        password = self.entry_password.text()

        usuario = session.query(Usuario).filter_by(username=username, password=password).first()
        if usuario:
            self.accept()
        else:
            QMessageBox.warning(self, "Erro", "Username ou senha incorretos")

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Sistema de Estoque")
        self.setStyleSheet("QMainWindow { background-color: #e0e0e0; }")

        inserir_button = QPushButton("Inserir Novo Produto")
        inserir_button.setStyleSheet("QPushButton { background-color: #2196F3; color: white; padding: 10px; border-radius: 5px; }")
        inserir_button.clicked.connect(self.abrir_inserir_produto)

        exibir_button = QPushButton("Exibir Produtos Cadastrados")
        exibir_button.setStyleSheet("QPushButton { background-color: #FF9800; color: white; padding: 10px; border-radius: 5px; }")
        exibir_button.clicked.connect(self.exibir_produtos)

        central_widget = QWidget()
        layout = QVBoxLayout()
        layout.setAlignment(Qt.AlignCenter)
        layout.addWidget(inserir_button)
        layout.addWidget(exibir_button)
        central_widget.setLayout(layout)
        self.setCentralWidget(central_widget)

    def abrir_inserir_produto(self):
        dialog = InserirProdutoDialog(self)
        dialog.exec_()

    def exibir_produtos(self):
        dialog = ExibirProdutosDialog(self)
        dialog.exec_()

if __name__ == "__main__":
    app = QApplication(sys.argv)

    login_dialog = LoginDialog()
    if login_dialog.exec_() == QDialog.Accepted:
        window = MainWindow()
        window.showMaximized()
        sys.exit(app.exec_())
